name: Eslint Lint Check

on:
  pull_request:
    branches: [main]

jobs:
  eslint-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Install dependencies
        run: npm ci

      - name: Run Prettier check
        id: eslint
        run: |
          set +e
          npm run lint:eslint . 2>&1 | tee ESLINT-output.txt
          ESLINT_EXIT_CODE=${PIPESTATUS[0]}
          set -e

          if [ $ESLINT_EXIT_CODE -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=✅ All files are formatted correctly!" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            ERROR_MESSAGE=$(cat ESLINT-output.txt)
            # Escape and format the error message for GitHub output
            echo "message<<EOF" >> $GITHUB_OUTPUT
            echo "❌ Eslint formatting issues found:" >> $GITHUB_OUTPUT
            echo "\`\`\`" >> $GITHUB_OUTPUT
            echo "$ERROR_MESSAGE" >> $GITHUB_OUTPUT
            echo "\`\`\`" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "PR will remain blocked from merging until issues are fixed." >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        if: github.event_name == 'pull_request'
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Eslint Lint Check"

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        if: github.event_name == 'pull_request'
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## Eslint Lint Check

            ${{ steps.eslint.outputs.message }}

            ---
            *Run ID: ${{ github.run_id }} | Commit: ${{ github.sha }}*

      - name: Fail workflow if prettier check failed
        if: steps.eslint.outputs.status == 'failure'
        run: exit 1
